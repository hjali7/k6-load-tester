name: Publish to Artifact Hub

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/artifacthub.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Package Helm chart
        run: |
          helm package charts/web-load-tester
          helm repo index .

      - name: Create Artifact Hub repository
        run: |
          curl -X POST \
            -H "X-API-KEY: lUp8P9QPOLAd0mrm7epiaK/ApcmmMLA9p2mNymRvbDE=" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "k6-load-tester",
              "displayName": "K6 Load Tester",
              "url": "https://github.com/hjali7/k6-load-tester",
              "kind": "helm",
              "private": false,
              "verifiedPublisher": false,
              "organizationName": "hjali7",
              "organizationDisplayName": "HajAli",
              "userAlias": "hjali7"
            }' \
            https://artifacthub.io/api/v1/repositories || true

      - name: Upload chart to Artifact Hub
        run: |
          curl -X POST \
            -H "X-API-KEY: lUp8P9QPOLAd0mrm7epiaK/ApcmmMLA9p2mNymRvbDE=" \
            -H "Content-Type: application/json" \
            -d @charts/web-load-tester/artifacthub-pkg.yml \
            https://artifacthub.io/api/v1/packages/helm/hjali7/k6-load-tester 